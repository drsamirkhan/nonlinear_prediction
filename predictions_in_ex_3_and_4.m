%data1=xd;
simout=[0;1.55619425478076e-57;9.99767946309574e-07;3.58985493563169e-05;0.000945622362071384;0.00850327931356083;0.0305686370487374;0.0638395063068237;0.109951234517576;0.173249386745066;0.247388704806366;0.308523297674686;0.283414477455483;0.180780905293736;0.0342968895216412;-0.122597675857307;-0.251869188029474;-0.286838228735533;-0.232154343140041;-0.116916488031102;0.0274531067374978;0.167456077594999;0.255821680092708;0.220783268529404;0.114404149828723;-0.0271418910109426;-0.172145511261420;-0.278324481015631;-0.271077047087838;-0.177131152877684;-0.0410558162733171;0.107063982109395;0.228706474765446;0.260577079508487;0.202346644529236;0.0846328676766631;-0.0609532110416212;-0.200685880376688;-0.285900875289735;-0.245477583373826;-0.136403176413811;0.00655003995866115;0.151369809668754;0.254994830068838;0.242881772654131;0.147161526060371;0.0104944319188039;-0.136711889314176;-0.255323494115139;-0.281867447264416;-0.219898852200272;-0.0999062458535355;0.0467133673981150;0.185967133102473;0.267766553000149;0.222106622266755;0.110719315305503;-0.0328357268508254;-0.176069644490913;-0.274563804919523;-0.254285237279054;-0.154748312748583;-0.0160412344555617;0.131069379959860;0.246639830252573;0.266891950296567;0.200799543261216;0.0786860799936022;-0.0681804275273679;-0.205305293584678;-0.279708383030570;-0.224287303770002;-0.108077497285025;0.0373480358813267;0.178726320641826;0.269013562972016;0.235693308157068;0.130188765061247;-0.0110637522469339;-0.156478319594450;-0.264163485404406;-0.259549906071543;-0.166780016148483;-0.0314397310091846;0.116467117470354;0.238577579549422;0.271786860333465;0.214340460602025;0.0969464952419287;-0.0487417523057932;-0.189122056609624;-0.276069285511134;-0.237949808333631;-0.130084693201722;0.0122403523734275;0.157138325025785;0.261909709653704;0.251987694625660;0.157102058916010;0.0207514378314027;-0.126793548214485;-0.246662813632877;-0.275453230957153;-0.215046274142490;-0.0959823937312572;0.0502608419739400;0.189815223914725;0.273264633776555;0.230045753280903;0.119770443930235;-0.0234541504383789;-0.167352926819992;-0.268137421105867;-0.251506385408211;-0.153667561419103;-0.0158313768004155;0.131410167145057;0.248507628373940;0.271780234427370;0.207697063520231;0.0866414441837628;-0.0600633254555620;-0.198160094840911;-0.276123143335863;-0.225372114191056;-0.111443766458171;0.0331573729456611;0.175561977570545;0.270117103715995;0.243396594243424;0.232090380159030;0.139953998085768;0.0867208378590005;-0.0578941296281224;-0.164566738253985;-0.194942732760387;-0.148836756236076;-0.0268638443257489;0.0904493278120190;0.166157154941943;0.170144137078478;0.282155693988551;0.233128202089317;0.117775418083130;-0.0289241595761659;-0.173535819853370;-0.269392779889154;-0.242735611012188;-0.139248139265919;0.00205622006475360;0.149010540601870;0.259347114206429;0.258168651028768;0.165429523672257;0.0291542075489598;-0.119847681217701;-0.242183057548749;-0.273943997089243;-0.213890227452063;-0.0938532355975396;0.0536181370886928;0.193693105997975;0.275166491108187;0.228659454765266;0.115505834557591;-0.0297827452865967;-0.173692904115862;-0.270034173598667;-0.245134370774759;-0.142292027616197;-0.00118136382396677;0.146171958767250;0.257779267446736;0.258743027291186;0.166850790988023;0.0310255577984134;-0.118010518524152;-0.241032281215179;-0.274261686137505;-0.215157162793969;-0.0956297915181897;0.0517099997973256;0.192126874234482;0.274902220562164;0.230172533198258;0.117879457106083;-0.0270956823757584;-0.171380087643531;-0.269237057321822;-0.246716209702992;-0.144970576294114;-0.00435229128886613;0.143250744320551;0.256182522622816;0.270136170248805;0.198164592607533;0.0716867012266225;-0.0771530998055962;-0.212195771550289;-0.274628790302929;-0.234463466028857;-0.124866853925939;0.0191446457688308;0.164445714228487;0.266537858750379;0.250860759614560;0.152195591532744;0.0130054037562515;-0.135194065944634;-0.251603353821957;-0.271845542130613;-0.204129715817284;-0.0799410697522731;0.0684992357815327;0.205541856651712;0.274001578517034;0.237847121961465;0.130255429025257;-0.0129581988685026;-0.158954920654926;-0.264067372369037;-0.253465910947796;-0.156995455579588;-0.0188628389079281;0.129671596612615;0.248358194472961;0.272908478559385;0.208081593451331;0.0854544212097344;-0.0626589864509330;-0.200932392833210;-0.275289959953307;-0.219351497522751;-0.101650969787793;0.0451448763092268;0.186706381345246;0.273886197879892;0.235335202820954;0.126022987688334;-0.0178155228995208;-0.163269750016274;-0.266000799391657;-0.251383514320734;-0.153184482287049;-0.0142168014549413;0.134058234706596;0.250961286232410;0.272125385688208;0.205029553918683;0.0811752047331930;-0.0671995362020910;-0.204516356229043;-0.274980257637967;-0.214104364577805;-0.0940418070750204;0.0534360312718005;0.193522986993726;0.275014462936765;0.228525103347512;0.115382254872613;-0.0298996125587426;-0.173807738001167;-0.270154331913532;-0.245266420491478;-0.142428017039101;-0.00131736483925799;0.146041091795190;0.257661334586479;0.258646029429182;0.166763029625545;0.0309437916895972;-0.118090033412517;-0.241114357772482;-0.274762227928341;-0.0524671591019004;-0.0524671591019545;-0.0604809040048603;-0.0481752945052117;-0.00517285528679763;0.0455324728914666;0.0606036913601407;0.0429714552440878;-0.00279775640879161;-0.0489085301688728;-0.0520385188773722;-0.272517506752838;-0.272517506752873;-0.242826639727631;-0.142566347737155;-0.00197107465303922;0.145126476212488;0.257127838827931;0.259208335784609;0.167605157199877;0.0319155634532051;-0.117206549858189;-0.240612867408649;-0.274567197577453;-0.215943208805559;-0.0966786182720021;0.0505865039592429;0.191163281265013;0.274567621112643;0.230710842674817;0.118840874556565;-0.0259754934214314;-0.170432695599148;-0.269005716315310;-0.247623596233157;-0.146396870705830;-0.00601229940677152;0.141707200947338;0.255259399367741;0.270307196515478;0.199079786239507;0.0730023979935048;-0.0757717673772447;-0.211175169833152;-0.274668619745943;-0.235211142311075;-0.125970071846312;0.0179047463634323;0.163340203090018;0.265993987842560;0.251244884638332;0.152988972002547;0.0139950590017492;-0.134268531184729;-0.251107168077352;-0.272152844115486;-0.204976840212021;-0.0810785376227814;0.0673063063078517;0.204590579431286;0.274915019322699;0.213864031127370;0.0937186925782339;-0.0537806531488996;-0.193809998581541;-0.275081874998254;-0.228294412086447;-0.115006979131229;0.0303272250356783;0.174171605709451;0.270260012916885;0.244969966598007;0.141945342260641;0.000752263104460937;-0.146560991734562;-0.257950054286790;-0.258507502585970;-0.166467941716918;-0.0305668208617803;0.118455163210189;0.241341555508754;0.274291373350709;0.215004603937204;0.0953780470965085;-0.0519898853016742;-0.192346198449262;-0.274882938339395;-0.229823878305063;-0.117372218968179;0.0276600718885596;0.171874099440403;0.269450204759405;0.246487257809631;0.144538009581194;0.00382688628761074;-0.143733184650994;-0.256426249347172;-0.269958212751917;-0.197700528711970;-0.0710700164213516;0.0777915893492394;0.212689112987726;0.274705090066564;0.234260247258949;0.124521874810580;-0.0195452091955820;-0.164795310800393;-0.266668179498616;-0.250628422413610;-0.151803561135880;-0.0125380789410805;0.135633297568570;0.251868994887145;0.271790132332381;0.203857793360577;0.0795520314884109;-0.0689116084775074;-0.205858986927329;-0.274019176746330;-0.237666951782525;-0.129977708552620;0.0132753500289232;0.159239526941281;0.264208833058477;0.253363205362362;0.156789113395690;0.0186056685566008;-0.129914899370713;-0.248498075981592;-0.272848758947971;-0.207888733079413;-0.0851896415484422;0.0629395106658935;0.201157916222319;0.275295860274101;0.219075155403939;0.101238947288608;-0.0455983602197390;-0.187080910607899;-0.273955539255550;-0.234968610824358;-0.125446829477383;0.0184740397952123;0.163852101912229;0.266257917025810;0.251100514536964;0.152664643220063;0.0135839641096758;-0.134652493531673;-0.251304438707237;-0.271999332842389;-0.204587943979846;-0.0805632416675118;0.0678454996209768;0.205024002850860;0.273908931882343;0.238035547648271;0.130582994626196;-0.0125732987351901;-0.158613869892718;-0.263925239353082;-0.253665114346356;-0.157338447196651;-0.0192758076873631;0.129279238453934;0.248111859689936;0.272942938358117;0.208303664933797;0.0857783366801864;-0.0623117010887132;-0.200660454282653;-0.275321741321823;-0.219775166604494;-0.102262673762624;0.0444760098123697;0.186147594297474;0.273750255080272;0.235804457170018;0.126783352086928;-0.0169395991267160;-0.162496822212088;-0.265672924526864;-0.251798624499838;-0.153923470337958;-0.0151105480469517;0.133216815053313;0.250462031128811;0.272267672333408;0.205603067287871;0.0819818870604433;-0.0663449574403304;-0.203847825619882;-0.275080061483397;-0.215166936785579;-0.0955631595141187;0.0517885935158569;0.192178069629497;0.274838969316751;0.229950709350460;0.117581878026601;-0.0274197336734716;-0.171668544870312;-0.269387391239791;-0.246650016414543;-0.144804168162740;-0.00413953486435165;0.143443927679572;0.256261270810710;0.270011352758696;0.197902014142360;0.0713510570114096;-0.0774983683182651;-0.212469633385120;-0.274699235603258;-0.234397260478349;-0.124730996506610;0.0193083527944307;0.164585655735312;0.266572645603606;0.250720817772281;0.151979117234454;0.0127531922771541;-0.135431968038270;-0.251756470295873;-0.271842555747250;-0.204021254907842;-0.0797752898495852;0.0686769712026548;0.205674243051547;0.273989782514576;0.237740361829985;0.130102078891389;-0.0131300828851739;-0.159110548826805;-0.264153245866089;-0.253433197376869;-0.156912208018805;-0.0187545825198357;0.129773636528546;0.248410842755771;0.272865228601379;0.207974520595450;0.0853130317139510;-0.0628075987761916;-0.201054079426063;-0.275305281713724;-0.219230319027053;-0.101464022566463;0.0453521765605844;0.186876023963512;0.273909360485458;0.235148756961291;0.125735912481651;-0.0181420294801385;-0.163559411640433;-0.266133836415755;-0.251256427010392;-0.152943333946927;-0.0139210714084454;0.134335768636686;0.251118648221863;0.272057703950423;0.204810625765604;0.0808747010868140;-0.0675162270983676;-0.204766595903220;-0.274956040592986;-0.232772414297670];
y=simout;
%y=[0,0.309016994374947,0.587785252292473,0.809016994374948,0.951056516295154,1,0.951056516295154,0.809016994374948,0.587785252292473,0.309016994374948,1.22464679914735e-16,-0.309016994374948,-0.587785252292473,-0.809016994374947,-0.951056516295154,-1,-0.951056516295154,-0.809016994374947,-0.587785252292473,-0.309016994374948,-2.44929359829471e-16,0.309016994374947,0.587785252292474,0.809016994374948,0.951056516295154,1,0.951056516295154,0.809016994374948,0.587785252292473,0.309016994374946,3.67394039744206e-16,-0.309016994374947,-0.587785252292473,-0.809016994374947,-0.951056516295154,-1,-0.951056516295154,-0.809016994374948,-0.587785252292474,-0.309016994374946,-4.89858719658941e-16,0.309016994374949,0.587785252292473,0.809016994374947,0.951056516295154,1,0.951056516295153,0.809016994374948,0.587785252292472,0.309016994374946,6.12323399573677e-16,-0.309016994374945,-0.587785252292470,-0.809016994374946,-0.951056516295153,-1,-0.951056516295154,-0.809016994374947,-0.587785252292474,-0.309016994374950,-7.34788079488412e-16,0.309016994374945,0.587785252292470,0.809016994374946,0.951056516295153,1,0.951056516295154,0.809016994374949,0.587785252292474,0.309016994374947,8.57252759403147e-16,-0.309016994374945,-0.587785252292470,-0.809016994374946,-0.951056516295153,-1,-0.951056516295154,-0.809016994374949,-0.587785252292474,-0.309016994374947,-9.79717439317883e-16,0.309016994374945,0.587785252292470,0.809016994374948,0.951056516295153,1,0.951056516295154,0.809016994374949,0.587785252292471,0.309016994374947,1.10218211923262e-15,-0.309016994374945,-0.587785252292469,-0.809016994374948,-0.951056516295153,-1,-0.951056516295154,-0.809016994374949,-0.587785252292471,-0.309016994374947,-1.22464679914735e-15];
%y2=[0,0.309016994374947,0.587785252292473,0,0,1,0.951056516295154,0.809016994374948,0.587785252292473,0.309016994374948,1.22464679914735e-16,-0.309016994374948,-0.587785252292473,-0.809016994374947,-0.951056516295154,-1,-0.951056516295154,-0.809016994374947,-0.587785252292473,-0.309016994374948,-2.44929359829471e-16,0.309016994374947,0.587785252292474,0.809016994374948,0.951056516295154,1,0.951056516295154,0.809016994374948,0.587785252292473,0.309016994374946,3.67394039744206e-16,-0.309016994374947,-0.587785252292473,-0.809016994374947,-0.951056516295154,-1,-0.951056516295154,-0.809016994374948,-0.587785252292474,-0.309016994374946,0,0,0,0.809016994374947,0.951056516295154,1,0.951056516295153,0.809016994374948,0.587785252292472,0.309016994374946,6.12323399573677e-16,-0.309016994374945,-0.587785252292470,-0.809016994374946,-0.951056516295153,-1,-0.951056516295154,-0.809016994374947,-0.587785252292474,-0.309016994374950,-7.34788079488412e-16,0.309016994374945,0.587785252292470,0.809016994374946,0.951056516295153,1,0.951056516295154,0.809016994374949,0.587785252292474,0.309016994374947,8.57252759403147e-16,0,0,0,0,-1,-0.951056516295154,-0.809016994374949,-0.587785252292474,-0.309016994374947,-9.79717439317883e-16,0.309016994374945,0.587785252292470,0.809016994374948,0.951056516295153,1,0.951056516295154,0.809016994374949,0.587785252292471,0.309016994374947,1.10218211923262e-15,-0.309016994374945,-0.587785252292469,-0.809016994374948,-0.951056516295153,-1,-0.951056516295154,-0.809016994374949,-0.587785252292471,-0.309016994374947,-1.22464679914735e-15];
data1=y;
[n_1,m_1]=size(data1); %m_1 is no of columns, n_1 no of rows
%% n-d phase space conversion

N = length(data1); tau =5; m1=2; % choose appropriate tau and embedding dimension using autocorrelation and FNN
N2 = N - tau * (m1 - 1); % recalculate length with tau delay

temp=zeros(N2,m_1*m1);
xe=zeros(N2,m1-1); 

for t_i=1:m_1
    Y_1=data1(:,t_i);
    for mi = 1:m1
        for k=1:N2
            xe(k, mi) = Y_1(k + tau*(mi-1));
        end
    end
    temp(:,m1*t_i-(m1-1):m1*t_i)=xe(:,:);
end

data1=temp;
data2=data1;

%% prediction

steps=100; % how many steps wanted for prediction
t_past=0; % how many steps in the past for overlap

m=0;n=0;intial_value=0;inc=0;
final_out=data2(1:steps,1);

%plot(data1(:,1))


for k=1:N2/steps % we analyse past steps samples to make a prediction.
data1=data2(1+inc:steps+inc,:);

m=length(data1);
n=m1;
dim=m1; %dim=n;



avg=zeros(steps,dim); % initialise the reponse matrix
i3=1; % this will be used for global column assignment



for i2=1:m_1 %(global)

    intial_value(1,1:dim)=data1(m-t_past,i3:i3+m1-1); % pick a starting point
    temp=0; % initialise temporary variable; n is the no of columns
    k_nn=n+1; % KNN has to be greater or equal to 2; rule of thumb

%------ being prediction process
    for i=1:steps % how many steps
        [cIdx,cD] = knnsearch(data1(1:m-t_past,i3:i3+m1-1),intial_value(1,1:dim),'K',k_nn,'Distance','euclidean');

        for j =2:k_nn % look at the future values of past responses
          
            if cIdx(1,j)==length(data1(:,i3:i3+m1-1)) % incase the nearest neighbour has no future value
                cIdx(1,j)=cIdx(1,j-1); % use the j-1 value
            end
        %avg(i,:)=avg(i,:)+X3(cIdx(1,j)+1,:);      
        temp=temp+data1(cIdx(1,j)+1,i3:i3+m1-1); % keep adding the nearest neighbour responses   

        end

    avg(i,i3:i3+m1-1)=temp/(k_nn-1); % take the average
    intial_value(1,1:dim)=avg(i,i3:i3+m1-1); 
    %data1(i+m,1:dim)=intial_value(1,1:dim);
    temp=0;
    end
    
    i3=i3+m1;
    
    %plotting phase space for 2-d or 3-d 
    %plot3(avg(:,1),avg(:,2),avg(:,3));
    %hold on;
    %plot(avg(:,1),avg(:,2));
end

final_out(m-t_past+1+inc:m-t_past+steps+inc,1)=avg(1:steps,1); % store all the predictions
hold on
%plot(m-t_past+1+inc:m-t_past+steps+inc,avg(:,1)) % plot the predictions
%line([m-t_past+1+inc m-t_past+1+inc], [-1 1]); % plot lines at start of prediction 
inc=inc+steps; % variable for tracking first row of next prediction 
end

plot(final_out)
%% Anomaly likelihood
out1=final_out(1:N2,1)-data2(1:N2,1);
W1=10;
M1 = movmean(out1,W1);
zScores = (M1 - mean(M1))./(std(M1)); %you can use filtered score instead of M1
zScores = (zScores > 0).*zScores;
AL = 1 - exp(-zScores.^2/2);
plot(AL)